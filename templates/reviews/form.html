{% extends "base.html" %}

{% block title %}{{ 'Editar' if review else 'Nova' }} Revisão - Revisões Jurídicas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-{{ 'edit' if review else 'plus' }}"></i> {{ 'Editar' if review else 'Nova' }} Revisão</h1>
    <a href="{{ url_for('reviews.manage') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
</div>

<form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- Informações do Documento -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-file-alt"></i> Informações do Documento</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Título do Documento *</label>
                <input type="text" name="title" class="form-control" value="{{ review.title if review else '' }}" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Resumo - Breve Descrição do Objeto do Documento</label>
                <textarea name="description" class="form-control" rows="5">{{ review.description if review else '' }}</textarea>
            </div>
        </div>
    </div>
    
    <!-- Revisões -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Revisões</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Responsável pela Revisão</label>
                    <input type="text" class="form-control" value="{{ current_user.name }}" disabled>
                    <small class="form-text text-muted">Preenchido automaticamente</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Data/Hora da Revisão</label>
                    <input type="text" class="form-control" id="review_datetime" value="" disabled>
                    <small class="form-text text-muted">Preenchido automaticamente</small>
                </div>
            </div>
            {% if review %}
            <div class="mb-3">
                <label class="form-label">Versão</label>
                <input type="text" class="form-control" value="v{{ review.version }} (Nova versão será criada)" disabled>
            </div>
            {% endif %}
            <div class="mb-3">
                <label class="form-label">Comentários da Revisão</label>
                <textarea name="comments" class="form-control" rows="5">{{ review.comments if review else '' }}</textarea>
            </div>
        </div>
    </div>
    
    <!-- Riscos -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Riscos Identificados e Tratamento</h5>
        </div>
        <div class="card-body" id="risks-container">
            {% if review and review.risks %}
                {% for risk in review.risks %}
                <div class="risk-item mb-3 p-3 border rounded">
                    <div class="mb-3">
                        <label class="form-label">Risco Identificado</label>
                        <textarea name="risk_text[]" class="form-control" rows="2">{{ risk.risk_text }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sugestão do Jurídico</label>
                        <textarea name="legal_suggestion[]" class="form-control" rows="2">{{ risk.legal_suggestion }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Definição Final</label>
                        <textarea name="final_definition[]" class="form-control" rows="2">{{ risk.final_definition }}</textarea>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-risk">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <div class="risk-item mb-3 p-3 border rounded">
                    <div class="mb-3">
                        <label class="form-label">Risco Identificado</label>
                        <textarea name="risk_text[]" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sugestão do Jurídico</label>
                        <textarea name="legal_suggestion[]" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Definição Final</label>
                        <textarea name="final_definition[]" class="form-control" rows="2"></textarea>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-risk">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                </div>
            {% endif %}
            <button type="button" class="btn btn-sm btn-primary" id="add-risk">
                <i class="fas fa-plus"></i> Adicionar Risco
            </button>
        </div>
    </div>
    
    <!-- Observações Gerais -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-sticky-note"></i> Observações Gerais</h5>
        </div>
        <div class="card-body">
            <textarea name="observations" class="form-control" rows="5">{{ review.observations if review else '' }}</textarea>
            <small class="form-text text-muted">Comentários adicionais sobre riscos futuros, compliance, ajustes recomendados, etc.</small>
        </div>
    </div>
    
    <!-- Upload de Documentos -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-paperclip"></i> Documentos Anexos</h5>
        </div>
        <div class="card-body">
            <input type="file" name="files" class="form-control" multiple accept=".pdf,.doc,.docx,.txt,.rtf">
            <small class="form-text text-muted">Formatos permitidos: PDF, DOC, DOCX, TXT, RTF. Máximo 10MB por arquivo.</small>
        </div>
    </div>
    
    <div class="d-flex justify-content-end">
        <a href="{{ url_for('reviews.manage') }}" class="btn btn-secondary me-2">Cancelar</a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Salvar
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';
    
    // Namespace único para evitar conflitos
    const RISK_MANAGER_KEY = 'riskManagerInitialized';
    
    // Verificar se já foi inicializado
    if (window[RISK_MANAGER_KEY]) {
        return;
    }
    window[RISK_MANAGER_KEY] = true;
    
    // Preencher data/hora atual ao carregar a página
    function initDateTime() {
        const now = new Date();
        const dateTimeStr = now.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const datetimeField = document.getElementById('review_datetime');
        if (datetimeField) {
            datetimeField.value = dateTimeStr;
        }
    }
    
    // Inicializar gerenciamento de riscos
    function initRiskManager() {
        const container = document.getElementById('risks-container');
        if (!container) return;
        
        const addRiskBtn = document.getElementById('add-risk');
        if (!addRiskBtn) return;
        
        // Verificar se já foi inicializado neste elemento
        if (addRiskBtn.dataset.initialized === 'true') {
            return;
        }
        addRiskBtn.dataset.initialized = 'true';
        
        let isAdding = false;
        
        // Handler para adicionar risco
        function handleAddRisk(e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            
            if (isAdding) {
                return false;
            }
            
            isAdding = true;
            
            const newRisk = document.createElement('div');
            newRisk.className = 'risk-item mb-3 p-3 border rounded';
            newRisk.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Risco Identificado</label>
                    <textarea name="risk_text[]" class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Sugestão do Jurídico</label>
                    <textarea name="legal_suggestion[]" class="form-control" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Definição Final</label>
                    <textarea name="final_definition[]" class="form-control" rows="2"></textarea>
                </div>
                <button type="button" class="btn btn-sm btn-danger remove-risk">
                    <i class="fas fa-trash"></i> Remover
                </button>
            `;
            
            container.insertBefore(newRisk, addRiskBtn);
            
            setTimeout(function() {
                isAdding = false;
            }, 200);
            
            return false;
        }
        
        // Handler para remover risco (event delegation)
        let isRemoving = false;
        function handleRemoveRisk(e) {
            const removeBtn = e.target.closest('.remove-risk');
            if (!removeBtn) return;
            
            e.preventDefault();
            e.stopImmediatePropagation();
            
            if (isRemoving) {
                return false;
            }
            
            isRemoving = true;
            
            const riskItem = removeBtn.closest('.risk-item');
            if (riskItem) {
                riskItem.remove();
            }
            
            setTimeout(function() {
                isRemoving = false;
            }, 200);
            
            return false;
        }
        
        // Adicionar listeners
        addRiskBtn.addEventListener('click', handleAddRisk, true);
        container.addEventListener('click', handleRemoveRisk, true);
    }
    
    // Aguardar DOM estar pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initDateTime();
            initRiskManager();
        });
    } else {
        initDateTime();
        initRiskManager();
    }
})();
</script>
{% endblock %}

